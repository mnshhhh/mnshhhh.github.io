<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>微信登录 - 企业服务号</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="logo-area">
            <div class="logo"></div>
            <h1>企业服务平台</h1>
            <p>请登录您的账号</p>
        </div>
        
        <div class="form-area">
            <div class="input-group">
                <input type="text" id="username" placeholder="请输入账号" required>
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="请输入密码" required>
            </div>
            <button id="loginBtn" class="login-btn">登录</button>
            
            <div class="wechat-quick-login" id="wechatQuickLogin">
                <p>或者使用微信一键登录</p>
                <button id="wechatLoginBtn" class="wechat-btn">
                    <span class="wechat-icon"></span>
                    微信一键登录
                </button>
            </div>
        </div>
    </div>

    <script>
        // 微信授权配置
        const WECHAT_CONFIG = {
            // 替换为实际的公众号AppID
            appId: 'gh_82da0c6143e6',
            // 授权回调域名（必须备案且已在微信公众号后台配置）
            redirectUri: encodeURIComponent('https://mnshhhh.github.io'),
            // 授权作用域，snsapi_base为静默授权
            scope: 'snsapi_base'
        };

        // 页面加载时检查URL中的code参数
        document.addEventListener('DOMContentLoaded', function() {
            // 从URL中获取code参数
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            
            if (code) {
                // 已获取到code，进行后续处理
                handleWechatAuthSuccess(code, state);
            } else {
                // 未获取到code，检查是否需要授权
                checkAuthStatus();
            }

            // 绑定登录按钮事件
            document.getElementById('loginBtn').addEventListener('click', handleManualLogin);
            document.getElementById('wechatLoginBtn').addEventListener('click', redirectToWechatAuth);
        });

        // 检查授权状态
        function checkAuthStatus() {
            // 可以检查本地存储中是否已有授权信息
            const hasAuth = localStorage.getItem('wechat_auth');
            
            if (!hasAuth) {
                // 如果没有授权信息，可以选择自动跳转授权或者让用户点击按钮授权
                console.log('未检测到微信授权信息');
            }
        }

        // 重定向到微信授权页面
        function redirectToWechatAuth() {
            // 生成随机state参数防止CSRF攻击
            const state = 'state_' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('wechat_auth_state', state);
            
            // 构造授权URL
            const authUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${WECHAT_CONFIG.appId}&redirect_uri=${WECHAT_CONFIG.redirectUri}&response_type=code&scope=${WECHAT_CONFIG.scope}&state=${state}#wechat_redirect`;
            
            console.log('即将跳转到微信授权页面:', authUrl);
            window.location.href = authUrl;
        }

        // 处理微信授权成功返回
        function handleWechatAuthSuccess(code, state) {
            // 首先在控制台打印用户的code
            console.log('授权后的用户code:', code);
            
            // 验证state参数，防止CSRF攻击
            const savedState = localStorage.getItem('wechat_auth_state');
            if (savedState !== state) {
                console.error('state参数验证失败，可能是CSRF攻击');
                return;
            }
            
            // 清除state参数
            localStorage.removeItem('wechat_auth_state');
            
            // 在控制台打印用户的code信息
            console.log('用户的微信授权code:', code);
            
            // 调用后端API，使用code换取openid和session_key
            // 这里需要替换为实际的后端API地址
            const apiUrl = 'https://your-api.com/wechat/auth';
            
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应错误');
                }
                return response.json();
            })
            .then(data => {
                console.log('微信授权处理结果:', data);
                
                // 存储授权信息
                localStorage.setItem('wechat_auth', JSON.stringify(data));
                
                // 显示登录成功提示
                showToast('微信授权成功');
                
                // 可以根据后端返回的信息决定是否需要进一步登录
                if (data.needLogin) {
                    // 需要进一步登录
                    console.log('需要进行账号绑定或二次登录');
                } else {
                    // 直接登录成功
                    setTimeout(() => {
                        window.location.href = '/home.html';
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('微信授权处理失败:', error);
                showToast('微信授权失败，请重试');
            });
        }

        // 处理手动登录
        function handleManualLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showToast('请输入账号和密码');
                return;
            }
            
            // 模拟登录请求
            console.log('正在登录...', { username });
            
            // 显示加载状态
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = '登录中...';
            
            // 模拟API请求延迟
            setTimeout(() => {
                // 模拟登录成功
                showToast('登录成功');
                
                // 跳转到首页
                setTimeout(() => {
                    window.location.href = '/home.html';
                }, 1500);
            }, 1500);
        }

        // 显示提示消息
        function showToast(message) {
            // 创建toast元素
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'toast';
                document.body.appendChild(toast);
            }
            
            // 设置消息内容
            toast.textContent = message;
            
            // 显示toast
            toast.classList.add('show');
            
            // 2秒后隐藏
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
    </script>
</body>
</html>