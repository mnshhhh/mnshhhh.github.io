<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>demo - 登录</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="logo-area">
            <div class="logo">
                <div class="logo-shape"></div>
                <span class="logo-text">Xpert</span>
                <span class="logo-subtext">Data Platform</span>
            </div>
            <p class="slogan">专家标注 驱动AI进化</p>
        </div>
        
        <div class="login-content">
            <p class="hint-text">未注册的手机号将自动注册</p>
            
            <button id="getCodeBtn" class="phone-quick-login-btn">获取微信授权Code</button>
            <button id="exchangeOpenidBtn" class="sms-login-btn">使用Code换取OpenID</button>
            
            <div class="agreement-section">
                <label class="checkbox-label">
                    <input type="checkbox" id="agreementCheckbox" checked>
                    <span class="checkbox-custom"></span>
                    <span class="agreement-text">我已阅读并同意 <a href="#">用户协议</a> 和 <a href="#">个人信息保护声明</a></span>
                </label>
            </div>
        </div>
    </div>

    <script>
        // 微信授权配置
        const WECHAT_CONFIG = {
            // 替换为实际的公众号AppID
            appId: 'wxe55515e7e5a6f61a',
            // 授权回调域名（必须备案且已在微信公众号后台配置）
            redirectUri: encodeURIComponent('https://mnshhhh.github.io'),
            // 授权作用域，snsapi_base为静默授权
            scope: 'snsapi_base'
        };

        // 页面加载时绑定事件
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定按钮事件
            document.getElementById('agreementCheckbox').addEventListener('change', handleAgreementChange);
            document.getElementById('getCodeBtn').addEventListener('click', handleGetCode);
            document.getElementById('exchangeOpenidBtn').addEventListener('click', handleExchangeOpenid);
            
            // 检查URL中是否已有code参数
            checkUrlForCode();
        });

        // 检查URL中是否已有code参数
        function checkUrlForCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                // 从URL中获取到code，存储到localStorage中
                localStorage.setItem('wechat_auth_code', code);
                console.log('从URL中获取到微信授权code:', code);
                showToast('已获取到微信授权Code');
                
                // 可选：如果需要，可以自动尝试使用code换取openid
                // handleExchangeOpenid();
            }
        }

        // 处理获取微信授权Code
        function handleGetCode() {
            if (!document.getElementById('agreementCheckbox').checked) {
                showToast('请阅读并同意用户协议和个人信息保护声明');
                return;
            }

            console.log('发起微信授权获取Code');
            
            // 生成随机state参数防止CSRF攻击
            const state = 'state_' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('wechat_auth_state', state);
            
            // 构造授权URL
            const authUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${WECHAT_CONFIG.appId}&redirect_uri=${WECHAT_CONFIG.redirectUri}&response_type=code&scope=${WECHAT_CONFIG.scope}&state=${state}#wechat_redirect`;
            
            console.log('即将跳转到微信授权页面:', authUrl);
            window.location.href = authUrl;
        }

        // 处理使用Code换取OpenID
        function handleExchangeOpenid() {
            if (!document.getElementById('agreementCheckbox').checked) {
                showToast('请阅读并同意用户协议和个人信息保护声明');
                return;
            }

            // 从localStorage中获取code
            const code = localStorage.getItem('wechat_auth_code');
            
            if (!code) {
                showToast('未找到微信授权Code，请先获取Code');
                return;
            }

            console.log('使用Code换取OpenID:', code);
            
            // 显示加载状态
            const exchangeBtn = document.getElementById('exchangeOpenidBtn');
            exchangeBtn.disabled = true;
            exchangeBtn.textContent = '请求中...';
            
            // 实际的后端API地址
            const apiUrl = 'https://xpert.bytedance.com/user/wechat/bind_status';
            
            fetch(apiUrl, {
                method: 'POST',
                mode: 'cors', // 使用CORS模式
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ code: code })
            })
            .then(response => {
                console.log('响应状态:', response.status);
                if (!response.ok) {
                    throw new Error('网络响应异常: ' + response.status);
                }
                return response.json(); // 解析JSON响应
            })
            .then(data => {
                console.log('获取到响应数据:', data);
                
                // 检查响应中是否包含openid
                if (data && data.openid) {
                    // 存储真实的OpenID信息
                    localStorage.setItem('wechat_openid', data.openid);
                    showToast('OpenID获取成功');
                } else {
                    // 响应中没有openid，生成模拟数据
                    const mockResponse = {
                        openid: 'mock_openid_' + Math.random().toString(36).substring(2, 15)
                    };
                    localStorage.setItem('wechat_openid', mockResponse.openid);
                    showToast('使用模拟OpenID');
                }
                
                // 恢复按钮状态
                exchangeBtn.disabled = false;
                exchangeBtn.textContent = '使用Code换取OpenID';
            })
            .catch(error => {
                console.error('请求处理失败:', error);
                
                // 即使失败也生成模拟数据
                showToast('遇到跨域问题，使用模拟数据继续');
                
                // 模拟成功响应
                const mockResponse = {
                    openid: 'mock_openid_' + Math.random().toString(36).substring(2, 15)
                };
                
                console.log('使用模拟数据:', mockResponse);
                
                // 存储模拟的OpenID信息
                localStorage.setItem('wechat_openid', mockResponse.openid);
                
                // 恢复按钮状态
                exchangeBtn.disabled = false;
                exchangeBtn.textContent = '使用Code换取OpenID';
            });
        }

        // 处理协议勾选状态变化
        function handleAgreementChange() {
            const isChecked = document.getElementById('agreementCheckbox').checked;
            console.log('协议勾选状态:', isChecked);
        }

        // 显示提示消息
        function showToast(message) {
            // 创建toast元素
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'toast';
                document.body.appendChild(toast);
            }
            
            // 设置消息内容
            toast.textContent = message;
            
            // 显示toast
            toast.classList.add('show');
            
            // 2秒后隐藏
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
    </script>
</body>
</html>